<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoScope — 反射測定 v1.2（閾値ガイド付き）</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>EchoScope — 反射測定（ホワイトノイズ短パルス + 手動 t₁/t₂）v1.2</h1>
    <p><b>手動指定はそのまま</b>、補助として<b>包絡＋相対閾値</b>と<b>候補ピーク</b>のガイドを追加。</p>
  </header>

  <section class="panel">
    <div class="row">
      <label>録音時間 (ms)
        <input id="recMs" type="number" min="200" step="50" value="1200">
      </label>
      <label>プレロール (ms)
        <input id="preMs" type="number" min="50" step="10" value="150">
      </label>
      <label>パルス種別
        <select id="pulseType">
          <option value="noise">ノイズ</option>
          <option value="sine" selected>サイン(1.5kHz)</option>
        </select>
      </label>
      <label>パルス長 (ms)
        <input id="pulseMs" type="number" min="2" step="1" value="60">
      </label>
      <label>パルス音量 (0〜1)
        <input id="pulseVol" type="number" min="0" max="1" step="0.05" value="0.8">
      </label>
    </div>

    <div class="row">
      <label>包絡窓 (ms)
        <input id="envMs" type="number" min="0.3" step="0.1" value="1.2">
      </label>
      <label>相対閾値 (0〜1)
        <input id="thresh" type="number" min="0.02" max="1" step="0.01" value="0.06">
      </label>
      <label>最小ピーク間隔 (ms)
        <input id="minSep" type="number" min="0.5" step="0.1" value="2.5">
      </label>
      <label class="inline"><input id="showCands" type="checkbox" checked> 候補表示</label>
      <button id="applyTop2">候補→t₁/t₂</button>
    </div>

    <div class="row">
      <button id="measureBtn">発音して測定</button>
      <button id="startBtn">録音のみ</button>
      <button id="stopBtn" disabled>停止</button>
      <button id="pulseTest">パルス再生テスト</button>
      <button id="exportBtn" disabled>CSV書き出し</button>
      <span id="status">準備OK</span>
    </div>
  </section>

  <section class="canvas-wrap">
    <canvas id="wave" width="1200" height="300" title="t₁/t₂ボタンを押してから、波形をクリックしてピーク位置を決めます"></canvas>
  </section>

  <section class="row">
    <button id="setT1">t₁手動</button>
    <button id="setT2">t₂手動</button>
    <button id="clearMarks">マーク消去</button>
  </section>

  <section class="results">
    <div>サンプルレート: <span id="sr">—</span> Hz</div>
    <div>t₁: <span id="t1">—</span> s ／ A₁: <span id="a1">—</span></div>
    <div>t₂: <span id="t2">—</span> s ／ A₂: <span id="a2">—</span></div>
    <div>Δt = <span id="dt">—</span> s</div>
  </section>

  <footer>
    <small>ガイドは表示のみで、<b>測定値は常に手動で決定</b>できます。iPhoneでは録音中の再生音が小さく聞こえる場合があります。</small>
  </footer>

  <script src="script.js"></script>
</body>
</html>
