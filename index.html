<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EchoScope — 反応時刻モード（音速測定用）</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>EchoScope — 反応時刻モード</h1>
    <p>マイクが<b>最初に反応した時刻</b>（しきい値超え）を求めます。パルス発音のタイミングを基準に <b>Δt</b> を表示。</p>
  </header>

  <section class="panel">
    <div class="row">
      <label>録音時間 (ms)
        <input id="recMs" type="number" min="100" step="50" value="1200">
      </label>
      <label>プレロール (ms) <span class="hint">発音の何ms前から録音するか</span>
        <input id="preMs" type="number" min="0" step="10" value="150">
      </label>
      <label>しきい値（0〜1）
        <input id="thresh" type="number" min="0.01" max="1" step="0.01" value="0.08">
      </label>
      <label>平滑窓 (ms)
        <input id="envMs" type="number" min="0.5" step="0.5" value="1.5">
      </label>
    </div>

    <div class="row">
      <label>パルス長 (ms)
        <input id="pulseMs" type="number" min="1" step="1" value="8">
      </label>
      <label>パルス音量 (0〜1)
        <input id="pulseVol" type="number" min="0" max="1" step="0.05" value="0.8">
      </label>
    </div>

    <div class="row">
      <button id="measureBtn">発音して測定（反応時刻）</button>
      <button id="pulseBtn">パルス再生（テスト）</button>
      <button id="startBtn">録音のみで測定</button>
      <button id="stopBtn" disabled>停止</button>
      <button id="exportBtn" disabled>CSV書き出し</button>
      <span id="status">準備OK</span>
    </div>
  </section>

  <section class="canvas-wrap">
    <canvas id="wave" width="1200" height="260"></canvas>
  </section>

  <section class="results">
    <div>サンプルレート: <span id="sr">—</span> Hz</div>
    <div>発音時刻 t_emit（録音基準）: <span id="tEmit">—</span> s</div>
    <div>マイク反応 t_mic（最初のピーク）: <span id="tMic">—</span> s</div>
    <div>Δt = t_mic − t_emit: <span id="dt">—</span> s</div>

    <details>
      <summary>（任意）距離から音速を計算</summary>
      <div class="row">
        <label>距離 d (m)
          <input id="dist" type="number" step="0.001" value="1.000">
        </label>
        <label>経路
          <select id="pathMode">
            <option value="one">片道（t = d / v）</option>
            <option value="round">往復（t = 2d / v）</option>
          </select>
        </label>
        <button id="calcVBtn">音速を求める</button>
      </div>
      <div>推定音速 v: <span id="v">—</span> m/s</div>
    </details>
  </section>

  <footer>
    <small>注：Δtはブラウザのスケジューリング誤差を極小化するため、<b>プレロール</b>値を用いて t_emit を決めています（t_emit ≈ preMs）。
    スピーカー直近の直音を拾う配置にすると精度が安定します。</small>
  </footer>

  <script src="script.js"></script>
</body>
</html>
